<?xml version="1.0" encoding="UTF-8"?>
<!--

All changeSets that should be run on startup need to have the context attribute set to one of the following values that
will be executed int order in which they are listed here. Changesets that have been executed will be registered in the
databasechangelog table by liquibase, to rerun change the id.

1.: definition  : The context for schema definition changes that create or alter a table or column
2.: initialvalue: The context for statements that insert or remove data
3.: constraint  : The context for adding schema constraints, such as unique constraints

See application.properties -> spring.liquibase.contexts
-->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
  <!-- complete db schema as of botify 1 -->
  <changeSet author="robinfriedli (generated)" id="1574552513560-1" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="access_configuration"/>
      </not>
    </preConditions>
    <createTable tableName="access_configuration">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="access_configuration_pkey"/>
      </column>
      <column name="command_identifier" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="guild_specification_pk" type="BIGINT"/>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-2" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="artist"/>
      </not>
    </preConditions>
    <createTable tableName="artist">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="artist_pkey"/>
      </column>
      <column name="id" type="VARCHAR(255)"/>
      <column name="name" type="VARCHAR(255)"/>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-3" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="command_history"/>
      </not>
    </preConditions>
    <createTable tableName="command_history">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="command_history_pkey"/>
      </column>
      <column name="command_body" type="VARCHAR(2000)"/>
      <column name="command_context_id" type="VARCHAR(255)"/>
      <column name="command_identifier" type="VARCHAR(255)"/>
      <column name="completed_successfully" type="BOOLEAN"/>
      <column name="duration_ms" type="BIGINT"/>
      <column name="error_message" type="VARCHAR(2000)"/>
      <column name="failed_manually" type="BOOLEAN"/>
      <column name="guild" type="VARCHAR(255)"/>
      <column name="guild_id" type="VARCHAR(255)"/>
      <column name="input" type="VARCHAR(2000)"/>
      <column name="is_widget" type="BOOLEAN"/>
      <column name="start_millis" type="BIGINT"/>
      <column name="timestamp" type="TIMESTAMP WITHOUT TIME ZONE"/>
      <column name="unexpected_exception" type="BOOLEAN"/>
      <column name="user_name" type="VARCHAR(255)"/>
      <column name="user_id" type="VARCHAR(255)"/>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-4" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="current_youtube_quota_usage"/>
      </not>
    </preConditions>
    <createTable tableName="current_youtube_quota_usage">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="current_youtube_quota_usage_pkey"/>
      </column>
      <column name="quota" type="INTEGER"/>
      <column name="lastupdated" type="TIMESTAMP WITHOUT TIME ZONE"/>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-5" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="granted_role"/>
      </not>
    </preConditions>
    <createTable tableName="granted_role">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="granted_role_pkey"/>
      </column>
      <column name="id" type="VARCHAR(255)"/>
      <column name="access_configuration_pk" type="BIGINT"/>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-6" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="guild_specification"/>
      </not>
    </preConditions>
    <createTable tableName="guild_specification">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="guild_specification_pkey"/>
      </column>
      <column name="argument_prefix" type="CHAR(1)"/>
      <column name="bot_name" type="VARCHAR(255)"/>
      <column name="color" type="VARCHAR(255)"/>
      <column name="default_list_source" type="VARCHAR(255)"/>
      <column name="default_source" type="VARCHAR(255)"/>
      <column name="default_text_channel_id" type="VARCHAR(255)"/>
      <column name="enable_auto_pause" type="BOOLEAN"/>
      <column name="guild_id" type="VARCHAR(255)"/>
      <column name="guild_name" type="VARCHAR(255)"/>
      <column name="prefix" type="VARCHAR(255)"/>
      <column name="send_playback_notification" type="BOOLEAN"/>
      <column name="temp_message_timeout" type="INTEGER"/>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-7" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="playback_history"/>
      </not>
    </preConditions>
    <createTable tableName="playback_history">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="playback_history_pkey"/>
      </column>
      <column name="guild" type="VARCHAR(255)"/>
      <column name="guild_id" type="VARCHAR(255)"/>
      <column name="source" type="VARCHAR(255)"/>
      <column name="timestamp" type="TIMESTAMP WITHOUT TIME ZONE"/>
      <column name="title" type="VARCHAR(255)"/>
      <column name="track_id" type="VARCHAR(255)"/>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-8" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="playback_history_artist"/>
      </not>
    </preConditions>
    <createTable tableName="playback_history_artist">
      <column name="playbackhistory_pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="playback_history_artist_pkey"/>
      </column>
      <column name="artists_pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="playback_history_artist_pkey"/>
      </column>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-9" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="playlist"/>
      </not>
    </preConditions>
    <createTable tableName="playlist">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="playlist_pkey"/>
      </column>
      <column name="created_user" type="VARCHAR(255)"/>
      <column name="created_user_id" type="VARCHAR(255)"/>
      <column name="guild" type="VARCHAR(255)"/>
      <column name="guild_id" type="VARCHAR(255)"/>
      <column name="name" type="VARCHAR(30)"/>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-10" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="preset"/>
      </not>
    </preConditions>
    <createTable tableName="preset">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="preset_pkey"/>
      </column>
      <column name="guild" type="VARCHAR(255)"/>
      <column name="guild_id" type="VARCHAR(255)"/>
      <column name="name" type="VARCHAR(30)"/>
      <column name="preset" type="VARCHAR(1000)"/>
      <column name="user_name" type="VARCHAR(255)"/>
      <column name="user_id" type="VARCHAR(255)"/>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-11" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="song"/>
      </not>
    </preConditions>
    <createTable tableName="song">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="song_pkey"/>
      </column>
      <column name="added_user" type="VARCHAR(255)"/>
      <column name="added_user_id" type="VARCHAR(255)"/>
      <column name="created_timestamp" type="TIMESTAMP WITHOUT TIME ZONE"/>
      <column name="duration" type="BIGINT"/>
      <column name="item_index" type="INTEGER"/>
      <column name="id" type="VARCHAR(255)"/>
      <column name="name" type="VARCHAR(255)"/>
      <column name="playlist_pk" type="BIGINT"/>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-12" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="song_artist"/>
      </not>
    </preConditions>
    <createTable tableName="song_artist">
      <column name="song_pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="song_artist_pkey"/>
      </column>
      <column name="artists_pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="song_artist_pkey"/>
      </column>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-13" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="spotify_redirect_index"/>
      </not>
    </preConditions>
    <createTable tableName="spotify_redirect_index">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="spotify_redirect_index_pkey"/>
      </column>
      <column name="last_updated" type="date"/>
      <column name="spotify_id" type="VARCHAR(255)"/>
      <column name="youtube_id" type="VARCHAR(255)"/>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-14" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="spotify_redirect_index_modification_lock"/>
      </not>
    </preConditions>
    <createTable tableName="spotify_redirect_index_modification_lock">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="spotify_redirect_index_modification_lock_pkey"/>
      </column>
      <column name="creation_time_stamp" type="TIMESTAMP WITHOUT TIME ZONE"/>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-15" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="url_track"/>
      </not>
    </preConditions>
    <createTable tableName="url_track">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="url_track_pkey"/>
      </column>
      <column name="added_user" type="VARCHAR(255)"/>
      <column name="added_user_id" type="VARCHAR(255)"/>
      <column name="created_timestamp" type="TIMESTAMP WITHOUT TIME ZONE"/>
      <column name="duration" type="BIGINT"/>
      <column name="item_index" type="INTEGER"/>
      <column name="title" type="VARCHAR(255)"/>
      <column name="url" type="VARCHAR(255)"/>
      <column name="playlist_pk" type="BIGINT"/>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-16" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="user_playback_history"/>
      </not>
    </preConditions>
    <createTable tableName="user_playback_history">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="user_playback_history_pkey"/>
      </column>
      <column name="user_id" type="VARCHAR(255)"/>
      <column name="user_name" type="VARCHAR(255)"/>
      <column name="playback_history_pk" type="BIGINT"/>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-17" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="video"/>
      </not>
    </preConditions>
    <createTable tableName="video">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="video_pkey"/>
      </column>
      <column name="added_user" type="VARCHAR(255)"/>
      <column name="added_user_id" type="VARCHAR(255)"/>
      <column name="created_timestamp" type="TIMESTAMP WITHOUT TIME ZONE"/>
      <column name="duration" type="BIGINT"/>
      <column name="item_index" type="INTEGER"/>
      <column name="id" type="VARCHAR(255)"/>
      <column name="redirected_spotify_id" type="VARCHAR(255)"/>
      <column name="spotify_track_name" type="VARCHAR(255)"/>
      <column name="title" type="VARCHAR(255)"/>
      <column name="playlist_pk" type="BIGINT"/>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-18" context="constraint">
    <preConditions onFail="MARK_RAN">
      <columnExists tableName="guild_specification" columnName="guild_id"/>
      <not>
        <sqlCheck expectedResult="1">select count(*) from pg_constraint where conname =
          'guild_specification_guild_id_key'
        </sqlCheck>
      </not>
    </preConditions>
    <addUniqueConstraint columnNames="guild_id" constraintName="guild_specification_guild_id_key" tableName="guild_specification"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-19" context="constraint">
    <preConditions onFail="MARK_RAN">
      <columnExists tableName="spotify_redirect_index" columnName="spotify_id"/>
      <not>
        <sqlCheck expectedResult="1">select count(*) from pg_constraint where conname = 'uk_9lvk6qqce02fxcnbbre8o2yj2'
        </sqlCheck>
      </not>
    </preConditions>
    <addUniqueConstraint columnNames="spotify_id" constraintName="uk_9lvk6qqce02fxcnbbre8o2yj2" tableName="spotify_redirect_index"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-21" context="constraint">
    <preConditions onFail="MARK_RAN">
      <columnExists tableName="artist" columnName="id"/>
      <not>
        <sqlCheck expectedResult="1">select count(*) from pg_constraint where conname = 'uk_ku11dq47spr24frr7wajkiv1q'
        </sqlCheck>
      </not>
    </preConditions>
    <addUniqueConstraint columnNames="id" constraintName="uk_ku11dq47spr24frr7wajkiv1q" tableName="artist"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-22" context="constraint">
    <preConditions onFail="MARK_RAN">
      <not>
        <foreignKeyConstraintExists foreignKeyName="fk7fmxitcixuooxr5ptd2nm51ws" foreignKeyTableName="video"/>
      </not>
    </preConditions>
    <addForeignKeyConstraint baseColumnNames="playlist_pk" baseTableName="video" constraintName="fk7fmxitcixuooxr5ptd2nm51ws" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="pk" referencedTableName="playlist" validate="true"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-23" context="constraint">
    <preConditions onFail="MARK_RAN">
      <not>
        <foreignKeyConstraintExists foreignKeyName="fk7k0t8vcxswxo8syktws77926r" foreignKeyTableName="song_artist"/>
      </not>
    </preConditions>
    <addForeignKeyConstraint baseColumnNames="artists_pk" baseTableName="song_artist" constraintName="fk7k0t8vcxswxo8syktws77926r" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="pk" referencedTableName="artist" validate="true"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-24" context="constraint">
    <preConditions onFail="MARK_RAN">
      <not>
        <foreignKeyConstraintExists foreignKeyName="fk_access_configuration" foreignKeyTableName="granted_role"/>
      </not>
    </preConditions>
    <addForeignKeyConstraint baseColumnNames="access_configuration_pk" baseTableName="granted_role" constraintName="fk_access_configuration" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="pk" referencedTableName="access_configuration" validate="true"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-25" context="constraint">
    <preConditions onFail="MARK_RAN">
      <not>
        <foreignKeyConstraintExists foreignKeyName="fk_guild_specification" foreignKeyTableName="access_configuration"/>
      </not>
    </preConditions>
    <addForeignKeyConstraint baseColumnNames="guild_specification_pk" baseTableName="access_configuration" constraintName="fk_guild_specification" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="pk" referencedTableName="guild_specification" validate="true"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-26" context="constraint">
    <preConditions onFail="MARK_RAN">
      <not>
        <foreignKeyConstraintExists foreignKeyName="fk_playback_history" foreignKeyTableName="user_playback_history"/>
      </not>
    </preConditions>
    <addForeignKeyConstraint baseColumnNames="playback_history_pk" baseTableName="user_playback_history" constraintName="fk_playback_history" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="pk" referencedTableName="playback_history" validate="true"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-27" context="constraint">
    <preConditions onFail="MARK_RAN">
      <not>
        <foreignKeyConstraintExists foreignKeyName="fka1ilbuil43ve4fdp086oqh6f4" foreignKeyTableName="playback_history_artist"/>
      </not>
    </preConditions>
    <addForeignKeyConstraint baseColumnNames="artists_pk" baseTableName="playback_history_artist" constraintName="fka1ilbuil43ve4fdp086oqh6f4" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="pk" referencedTableName="artist" validate="true"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-28" context="constraint">
    <preConditions onFail="MARK_RAN">
      <not>
        <foreignKeyConstraintExists foreignKeyName="fkc0n616ys9856pcla2sbrjpp30" foreignKeyTableName="song"/>
      </not>
    </preConditions>
    <addForeignKeyConstraint baseColumnNames="playlist_pk" baseTableName="song" constraintName="fkc0n616ys9856pcla2sbrjpp30" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="pk" referencedTableName="playlist" validate="true"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-29" context="constraint">
    <preConditions onFail="MARK_RAN">
      <not>
        <foreignKeyConstraintExists foreignKeyName="fkfp5cj0alx32js5svihn1ge8re" foreignKeyTableName="song_artist"/>
      </not>
    </preConditions>
    <addForeignKeyConstraint baseColumnNames="song_pk" baseTableName="song_artist" constraintName="fkfp5cj0alx32js5svihn1ge8re" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="pk" referencedTableName="song" validate="true"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-30" context="constraint">
    <preConditions onFail="MARK_RAN">
      <not>
        <foreignKeyConstraintExists foreignKeyName="fkogwcexnc7tauhn5eaxmek5lsq" foreignKeyTableName="url_track"/>
      </not>
    </preConditions>
    <addForeignKeyConstraint baseColumnNames="playlist_pk" baseTableName="url_track" constraintName="fkogwcexnc7tauhn5eaxmek5lsq" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="pk" referencedTableName="playlist" validate="true"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1574552513560-31" context="constraint">
    <preConditions onFail="MARK_RAN">
      <not>
        <foreignKeyConstraintExists foreignKeyName="fkrxie5r6i0lyey1ar08jfw914e" foreignKeyTableName="playback_history_artist"/>
      </not>
    </preConditions>
    <addForeignKeyConstraint baseColumnNames="playbackhistory_pk" baseTableName="playback_history_artist" constraintName="fkrxie5r6i0lyey1ar08jfw914e" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="pk" referencedTableName="playback_history" validate="true"/>
  </changeSet>
  <!-- end of initial schema -->



  <changeSet id="create_current_youtube_quota_usage-sd23d/1.6.LTS" author="robinfriedli" context="initialvalue" runAlways="true">
    <preConditions onFail="MARK_RAN">
      <sqlCheck expectedResult="0">select count(*) from current_youtube_quota_usage</sqlCheck>
    </preConditions>
    <insert tableName="current_youtube_quota_usage">
      <column name="quota" value="0"/>
    </insert>
  </changeSet>
  <changeSet id="delete_existing_spotify_redirect_index_modification_locks-sd23f/1.6.LTS" author="robinfriedli" context="initialvalue" runAlways="true">
    <preConditions onFail="MARK_RAN">
      <not>
        <sqlCheck expectedResult="0">select count(*) from spotify_redirect_index_modification_lock</sqlCheck>
      </not>
    </preConditions>
    <delete tableName="spotify_redirect_index_modification_lock"/>
  </changeSet>
  <changeSet id="migrate_lastupdated_to_last_updated_new_column-234ds/2.0" author="robinfriedli" context="definition">
    <preConditions onFail="MARK_RAN">
      <not>
        <columnExists tableName="current_youtube_quota_usage" columnName="last_updated"/>
      </not>
    </preConditions>
    <addColumn tableName="current_youtube_quota_usage">
      <column name="last_updated" type="TIMESTAMP"/>
    </addColumn>
  </changeSet>
  <changeSet id="migrate_lastupdated_to_last_updated_values-swersDS3/2.0" author="robinfriedli" context="initialvalue">
    <preConditions onFail="MARK_RAN">
      <columnExists tableName="current_youtube_quota_usage" columnName="lastupdated"/>
      <columnExists tableName="current_youtube_quota_usage" columnName="last_updated"/>
    </preConditions>
    <sql>update current_youtube_quota_usage set last_updated = lastupdated</sql>
  </changeSet>
  <changeSet id="migrate_lastupdated_to_last_updated_drop_old_column-2DEd2/2.0" author="robinfriedli" context="definition">
    <preConditions onFail="MARK_RAN">
      <columnExists tableName="current_youtube_quota_usage" columnName="lastupdated"/>
    </preConditions>
    <dropColumn tableName="current_youtube_quota_usage" columnName="lastupdated"/>
  </changeSet>
  <changeSet id="rename_playback_history_artist_playbackhistory_pk-ER3dE/2.0" author="robinfriedli" context="definition">
    <preConditions onFail="MARK_RAN">
      <columnExists tableName="playback_history_artist" columnName="playbackhistory_pk"/>
    </preConditions>
    <renameColumn tableName="playback_history_artist" oldColumnName="playbackhistory_pk" newColumnName="playback_history_pk"/>
  </changeSet>
  <changeSet id="rename_playback_history_artist_artists_pk-sd78D/2.0" author="robinfriedli" context="definition">
    <preConditions onFail="MARK_RAN">
      <columnExists tableName="playback_history_artist" columnName="artists_pk"/>
    </preConditions>
    <renameColumn tableName="playback_history_artist" oldColumnName="artists_pk" newColumnName="artist_pk"/>
  </changeSet>
  <changeSet id="rename_song_artist_artists_pk-Dfs23E/2.0" author="robinfriedli" context="definition">
    <preConditions onFail="MARK_RAN">
      <columnExists tableName="song_artist" columnName="artists_pk"/>
    </preConditions>
    <renameColumn tableName="song_artist" oldColumnName="artists_pk" newColumnName="artist_pk"/>
  </changeSet>
  <changeSet author="robin (generated)" id="1579479827217-1">
    <createTable tableName="script_usage">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="script_usagePK"/>
      </column>
      <column name="unique_id" type="VARCHAR(255)"/>
    </createTable>
  </changeSet>
  <changeSet author="robin (generated)" id="1579479827217-2">
    <createTable tableName="stored_script">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="stored_scriptPK"/>
      </column>
      <column name="guild_id" type="BIGINT"/>
      <column name="identifier" type="VARCHAR(30)"/>
      <column name="script" type="VARCHAR(1000)"/>
      <column name="script_usage_pk" type="BIGINT">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>
  <changeSet author="robin (generated)" id="1579479827217-3">
    <addUniqueConstraint columnNames="unique_id" constraintName="UC_SCRIPT_USAGEUNIQUE_ID_COL" tableName="script_usage"/>
  </changeSet>
  <changeSet author="robin (generated)" id="1579479827217-4">
    <addForeignKeyConstraint baseColumnNames="script_usage_pk" baseTableName="stored_script" constraintName="FKg10vja0avuakaq46cbjabx036" deferrable="false" initiallyDeferred="false" referencedColumnNames="pk" referencedTableName="script_usage" validate="true"/>
  </changeSet>
  <changeSet id="add_script_usage_value-SDew2d/2.0" author="robinfriedli" context="initialvalue">
    <preConditions onFail="MARK_RAN">
      <sqlCheck expectedResult="0">select count(*) from script_usage where unique_id = 'interceptor'</sqlCheck>
    </preConditions>
    <insert tableName="script_usage">
      <column name="unique_id" value="interceptor"/>
    </insert>
  </changeSet>
  <changeSet id="add_script_usage_value-sd3Dc/2.0" author="robinfriedli" context="initialvalue">
    <preConditions onFail="MARK_RAN">
      <sqlCheck expectedResult="0">select count(*) from script_usage where unique_id = 'script'</sqlCheck>
    </preConditions>
    <insert tableName="script_usage">
      <column name="unique_id" value="script"/>
    </insert>
  </changeSet>
  <changeSet id="add_script_usage_value-KD3cwc/2.0" author="robinfriedli" context="initialvalue">
    <preConditions onFail="MARK_RAN">
      <sqlCheck expectedResult="0">select count(*) from script_usage where unique_id = 'finalizer'</sqlCheck>
    </preConditions>
    <insert tableName="script_usage">
      <column name="unique_id" value="finalizer"/>
    </insert>
  </changeSet>
  <changeSet author="robin (generated)" id="1581299527413-1">
    <preConditions onFail="MARK_RAN">
      <not>
        <columnExists tableName="spotify_redirect_index" columnName="last_used"/>
      </not>
    </preConditions>
    <addColumn tableName="spotify_redirect_index">
      <column name="last_used" type="date"/>
    </addColumn>
  </changeSet>
  <changeSet id="set_last_used_now-DF4c3/1.6.LTS" author="robinfriedli" context="initialvalue">
    <preConditions>
      <columnExists tableName="spotify_redirect_index" columnName="last_used"/>
    </preConditions>
    <update tableName="spotify_redirect_index">
      <column name="last_used" valueDate="NOW()"/>
      <where>last_used is null</where>
    </update>
  </changeSet>
  <changeSet author="robin (generated)" id="1581484740467-1">
    <createTable tableName="client_session">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="client_sessionPK"/>
      </column>
      <column name="guild_id" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="ip_address" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="last_refresh" type="TIMESTAMP WITHOUT TIME ZONE">
        <constraints nullable="false"/>
      </column>
      <column name="session_id" type="UUID">
        <constraints nullable="false"/>
      </column>
      <column name="text_channel_id" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="user_id" type="BIGINT">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>
  <changeSet author="robin (generated)" id="1581484740467-2">
    <createTable tableName="generated_token">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="generated_tokenPK"/>
      </column>
      <column name="ip" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="token" type="UUID">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>
  <changeSet author="robin (generated)" id="1581484740467-3">
    <addUniqueConstraint columnNames="session_id" constraintName="UC_CLIENT_SESSIONSESSION_ID_COL" tableName="client_session"/>
  </changeSet>
  <changeSet author="robin (generated)" id="1581484740467-4">
    <addUniqueConstraint columnNames="token" constraintName="UC_GENERATED_TOKENTOKEN_COL" tableName="generated_token"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1582994667748-1">
    <addColumn tableName="guild_specification">
      <column name="enable_scripting" type="boolean"/>
    </addColumn>
  </changeSet>

  <!-- botify v2 - spotify schema migration -->
  <changeSet author="robin (generated)" id="1591375305578-1">
    <createTable tableName="episode">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints nullable="false" primaryKey="true" primaryKeyName="episodePK"/>
      </column>
      <column name="added_user" type="VARCHAR(255)"/>
      <column name="added_user_id" type="VARCHAR(255)"/>
      <column name="created_timestamp" type="TIMESTAMP WITHOUT TIME ZONE"/>
      <column name="duration" type="BIGINT"/>
      <column name="item_index" type="INTEGER"/>
      <column name="id" type="VARCHAR(255)"/>
      <column name="name" type="VARCHAR(255)"/>
      <column name="show_id" type="VARCHAR(255)"/>
      <column name="show_name" type="VARCHAR(255)"/>
      <column name="playlist_pk" type="BIGINT"/>
    </createTable>
  </changeSet>
  <changeSet author="robin (generated)" id="1591375305578-2">
    <createTable tableName="playback_history_source">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints nullable="false" primaryKey="true" primaryKeyName="playback_history_sourcePK"/>
      </column>
      <column name="unique_id" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>
  <changeSet id="insert_playback_history_source_values-dE32F32/v2.0" author="robinfriedli" runAlways="true">
    <customChange class="net.robinfriedli.aiode.persist.customchange.PlaybackHistorySourceInitialValues"/>
  </changeSet>
  <changeSet author="robin (generated)" id="1591375305578-3">
    <createTable tableName="spotify_item_kind">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints nullable="false" primaryKey="true" primaryKeyName="spotify_item_kindPK"/>
      </column>
      <column name="unique_id" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>
  <changeSet id="insert_spotify_item_kind_values-9De8d2/v2.0" author="robinfriedli" runAlways="true">
    <customChange class="net.robinfriedli.aiode.persist.customchange.SpotifyItemKindInitialValues"/>
  </changeSet>
  <changeSet author="robin (generated)" id="1591375305578-4">
    <addColumn tableName="video">
      <column name="fk_redirected_spotify_kind" type="int8"/>
    </addColumn>
  </changeSet>
  <changeSet id="set_redirected_spotify_kind-Sd2v1/v2.0" author="robinfriedli">
    <preConditions onFail="MARK_RAN">
      <columnExists tableName="video" columnName="fk_redirected_spotify_kind"/>
      <not>
        <sqlCheck expectedResult="0">SELECT count(*) FROM video where redirected_spotify_id IS NOT NULL AND fk_redirected_spotify_kind IS NULL</sqlCheck>
      </not>
    </preConditions>
    <update tableName="video">
      <column name="fk_redirected_spotify_kind" valueComputed="(SELECT pk FROM spotify_item_kind WHERE unique_id = 'TRACK')"/>
      <where>redirected_spotify_id IS NOT NULL AND fk_redirected_spotify_kind IS NULL</where>
    </update>
  </changeSet>
  <changeSet author="robin (generated)" id="1591375305578-5">
    <addColumn tableName="playback_history">
      <column name="fk_source" type="int8"/>
    </addColumn>
  </changeSet>
  <changeSet author="robin (generated)" id="1591375305578-6">
    <addColumn tableName="playback_history">
      <column name="fk_spotify_item_kind" type="int8"/>
    </addColumn>
  </changeSet>
  <changeSet author="robin (generated)" id="1591375305578-7">
    <addColumn tableName="spotify_redirect_index">
      <column name="fk_spotify_item_kind" type="int8"/>
    </addColumn>
  </changeSet>
  <changeSet id="set_spotify_item_kind_for_existing_spotify_redirect_indices-D3FD5/v2.0" author="robinfriedli">
    <preConditions onFail="MARK_RAN">
      <not>
        <sqlCheck expectedResult="0">SELECT count(*) from spotify_redirect_index</sqlCheck>
      </not>
    </preConditions>
    <update tableName="spotify_redirect_index">
      <column name="fk_spotify_item_kind" valueComputed="(select pk from spotify_item_kind where unique_id = 'TRACK')"/>
    </update>
  </changeSet>
  <changeSet id="add_not_null_constraint_for_spotify_redirect_index_fk_spotify_item_kind" author="robinfriedli">
    <preConditions>
      <columnExists tableName="spotify_redirect_index" columnName="fk_spotify_item_kind"/>
    </preConditions>
    <addNotNullConstraint tableName="spotify_redirect_index" columnName="fk_spotify_item_kind"/>
  </changeSet>
  <changeSet author="robin (generated)" id="1591375305578-8">
    <addUniqueConstraint columnNames="unique_id" constraintName="UC_PLAYBACK_HISTORY_SOURCEUNIQUE_ID_COL" tableName="playback_history_source"/>
  </changeSet>
  <changeSet author="robin (generated)" id="1591375305578-9">
    <addUniqueConstraint columnNames="unique_id" constraintName="UC_SPOTIFY_ITEM_KINDUNIQUE_ID_COL" tableName="spotify_item_kind"/>
  </changeSet>
  <changeSet author="robin (generated)" id="1591375305578-10">
    <addForeignKeyConstraint baseColumnNames="playlist_pk" baseTableName="episode" constraintName="FKijn2bb72bgaiyg0e5vc221g1h" deferrable="false" initiallyDeferred="false" referencedColumnNames="pk" referencedTableName="playlist" validate="true"/>
  </changeSet>
  <changeSet author="robin (generated)" id="1591375305578-11">
    <addForeignKeyConstraint baseColumnNames="fk_source" baseTableName="playback_history" constraintName="playback_history_fk_source_fkey" deferrable="false" initiallyDeferred="false" referencedColumnNames="pk" referencedTableName="playback_history_source" validate="true"/>
  </changeSet>
  <changeSet author="robin (generated)" id="1591375305578-12">
    <addForeignKeyConstraint baseColumnNames="fk_spotify_item_kind" baseTableName="playback_history" constraintName="playback_history_fk_spotify_item_kind_fkey" deferrable="false" initiallyDeferred="false" referencedColumnNames="pk" referencedTableName="spotify_item_kind" validate="true"/>
  </changeSet>
  <changeSet author="robin (generated)" id="1591375305578-13">
    <addForeignKeyConstraint baseColumnNames="fk_spotify_item_kind" baseTableName="spotify_redirect_index" constraintName="spotify_redirect_index_fk_spotify_item_kind_fkey" deferrable="false" initiallyDeferred="false" referencedColumnNames="pk" referencedTableName="spotify_item_kind" validate="true"/>
  </changeSet>
  <changeSet author="robin (generated)" id="1591375305578-14">
    <addForeignKeyConstraint baseColumnNames="fk_redirected_spotify_kind" baseTableName="video" constraintName="video_fk_redirected_spotify_kind_fkey" deferrable="false" initiallyDeferred="false" referencedColumnNames="pk" referencedTableName="spotify_item_kind" validate="true"/>
  </changeSet>
  <changeSet id="migrate_playback_history_sources-7D3x32/v2.0" author="robinfriedli">
    <preConditions onFail="MARK_RAN">
      <columnExists tableName="playback_history" columnName="source"/>
    </preConditions>
    <customChange class="net.robinfriedli.aiode.persist.customchange.MigratePlaybackHistorySource"/>
  </changeSet>
  <changeSet author="robin (generated)" id="1591375305578-15">
    <dropColumn columnName="source" tableName="playback_history"/>
  </changeSet>

  <!-- botify v2 - scripting and permission expansion -->
  <changeSet author="robinfriedli (generated)" id="1608654895507-1">
    <addColumn tableName="stored_script">
      <column name="active" type="boolean" defaultValueBoolean="true">
        <constraints nullable="false"/>
      </column>
    </addColumn>
  </changeSet>
  <changeSet author="robinfriedli" id="rename_column_access_configuration_command_identifier_to_permission_identifier-sdfesd/v2.0">
    <preConditions onFail="MARK_RAN">
      <columnExists tableName="access_configuration" columnName="command_identifier"/>
    </preConditions>
    <renameColumn tableName="access_configuration" oldColumnName="command_identifier" newColumnName="permission_identifier"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1608740624573-2">
    <createTable tableName="custom_permission_target">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints nullable="false" primaryKey="true" primaryKeyName="custom_permission_targetPK"/>
      </column>
      <column name="guild" type="VARCHAR(255)"/>
      <column name="guild_id" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="identifier" type="VARCHAR(30)">
        <constraints nullable="false"/>
      </column>
      <column name="user_name" type="VARCHAR(255)"/>
      <column name="user_id" type="BIGINT"/>
    </createTable>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1608740624573-1">
    <dropDefaultValue columnDataType="boolean" columnName="active" tableName="stored_script"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1608809046613-1">
    <createTable tableName="permission_type">
      <column autoIncrement="true" name="pk" type="BIGINT">
        <constraints nullable="false" primaryKey="true" primaryKeyName="permission_typePK"/>
      </column>
      <column name="unique_id" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>
  <changeSet id="insert_permission_type_values-4dfgdf42/2.0" author="robinfriedli" runAlways="true">
    <customChange class="net.robinfriedli.aiode.persist.customchange.PermissionTargetTypeInitialValues"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1608809046613-2">
    <addColumn tableName="access_configuration">
      <column name="fk_permission_type" type="int8"/>
    </addColumn>
  </changeSet>
  <changeSet author="robinfriedli" id="set_default_access_configuration_permission_type-dsf324Df/2.0">
    <preConditions>
      <columnExists tableName="access_configuration" columnName="fk_permission_type"/>
    </preConditions>
    <update tableName="access_configuration">
      <column name="fk_permission_type" valueComputed="(select pk from permission_type where unique_id = 'COMMAND')"/>
      <where>fk_permission_type is null</where>
    </update>
  </changeSet>
  <changeSet author="robinfriedli" id="add_access_configuration_fk_permission_type_not_null_constraint-sd32Dfs/2.0">
    <preConditions>
      <columnExists tableName="access_configuration" columnName="fk_permission_type"/>
    </preConditions>
    <addNotNullConstraint tableName="access_configuration" columnName="fk_permission_type"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1608809046613-3">
    <addUniqueConstraint columnNames="unique_id" constraintName="UC_PERMISSION_TYPEUNIQUE_ID_COL" tableName="permission_type"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1608809046613-4">
    <addForeignKeyConstraint baseColumnNames="fk_permission_type" baseTableName="access_configuration" constraintName="access_configuration_fk_permission_type_fkey" deferrable="false" initiallyDeferred="false" referencedColumnNames="pk" referencedTableName="permission_type" validate="true"/>
  </changeSet>
  <changeSet author="robinfriedli" id="rename_foreign_key_constraint_access_configuration_fk_guild_specification_drop-sd34hn/2.0">
    <preConditions onFail="MARK_RAN">
      <foreignKeyConstraintExists foreignKeyName="fk_guild_specification"/>
    </preConditions>
    <dropForeignKeyConstraint baseTableName="access_configuration" constraintName="fk_guild_specification"/>
  </changeSet>
  <changeSet author="robinfriedli" id="rename_column_access_configuration_guild_specification_pk-45Fgr8/2.0">
    <preConditions onFail="MARK_RAN">
      <columnExists tableName="access_configuration" columnName="guild_specification_pk"/>
    </preConditions>
    <renameColumn tableName="access_configuration" oldColumnName="guild_specification_pk" newColumnName="fk_guild_specification"/>
  </changeSet>
  <changeSet author="robinfriedli" id="">
    <preConditions onFail="MARK_RAN">
      <not>
        <foreignKeyConstraintExists foreignKeyName="access_configuration_fk_guild_specification_fkey"/>
      </not>
    </preConditions>
    <addForeignKeyConstraint baseTableName="access_configuration" baseColumnNames="fk_guild_specification" constraintName="access_configuration_fk_guild_specification_fkey" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="pk" referencedTableName="guild_specification" validate="true"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1609014530316-1">
    <addColumn tableName="command_history">
      <column name="aborted" type="boolean"/>
    </addColumn>
  </changeSet>
  <changeSet author="robinfriedli" id="set_command_history_aborted_initial_values-435FDr4/2.0">
    <preConditions>
      <columnExists tableName="command_history" columnName="aborted"/>
    </preConditions>
    <update tableName="command_history">
      <column name="aborted" valueBoolean="false"/>
      <where>aborted is null</where>
    </update>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1609015555077-1">
    <addNotNullConstraint columnDataType="boolean" columnName="aborted" tableName="command_history" validate="true"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1609015555077-2">
    <addNotNullConstraint columnDataType="boolean" columnName="completed_successfully" tableName="command_history" validate="true"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1609015555077-3">
    <addNotNullConstraint columnDataType="bigint" columnName="duration_ms" tableName="command_history" validate="true"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1609015555077-4">
    <addNotNullConstraint columnDataType="boolean" columnName="failed_manually" tableName="command_history" validate="true"/>
  </changeSet>
  <changeSet id="1609015555077-5-initalvalues" author="robinfriedli">
    <preConditions>
      <columnExists tableName="command_history" columnName="is_widget"/>
    </preConditions>
    <update tableName="command_history">
      <column name="is_widget" valueBoolean="false"/>
      <where>is_widget is null</where>
    </update>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1609015555077-5">
    <addNotNullConstraint columnDataType="boolean" columnName="is_widget" tableName="command_history" validate="true"/>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1609015555077-6">
    <addNotNullConstraint columnDataType="bigint" columnName="start_millis" tableName="command_history" validate="true"/>
  </changeSet>
  <changeSet id="1609015555077-7-initalvalues" author="robinfriedli">
    <preConditions>
      <columnExists tableName="command_history" columnName="unexpected_exception"/>
    </preConditions>
    <update tableName="command_history">
      <column name="unexpected_exception" valueBoolean="false"/>
      <where>unexpected_exception is null</where>
    </update>
  </changeSet>
  <changeSet author="robinfriedli (generated)" id="1609015555077-7">
    <addNotNullConstraint columnDataType="boolean" columnName="unexpected_exception" tableName="command_history" validate="true"/>
  </changeSet>
    <changeSet author="esieb (generated)" id="1637093581219-1">
        <addColumn tableName="guild_specification">
            <column name="default_volume" type="int4"/>
        </addColumn>
    </changeSet>
</databaseChangeLog>
